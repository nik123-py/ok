import React, { useState, useEffect, useRef } from 'react'
import axios from 'axios'
import './Pages.css'

const API_BASE = 'http://localhost:8003/api'
const STORAGE_KEY_API = 'art_ai_chat_api_key'

function PentestChatPage() {
    const [apiKey, setApiKey] = useState('')
    const [messages, setMessages] = useState([])
    const [input, setInput] = useState('')
    const [loading, setLoading] = useState(false)
    const [showApiKey, setShowApiKey] = useState(false)
    const messagesEndRef = useRef(null)

    useEffect(() => {
        const stored = localStorage.getItem(STORAGE_KEY_API)
        if (stored) setApiKey(stored)
    }, [])

    useEffect(() => {
        if (apiKey) localStorage.setItem(STORAGE_KEY_API, apiKey)
    }, [apiKey])

    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
    }, [messages])

    const sendMessage = async (text) => {
        const trimmed = (text || input).trim()
        if (!trimmed) return

        setInput('')
        setMessages((prev) => [...prev, { role: 'user', content: trimmed }])
        setLoading(true)

        try {
            const conversation_history = [
                ...messages.map((m) => ({ role: m.role, content: m.content })),
                { role: 'user', content: trimmed }
            ]
            const response = await axios.post(`${API_BASE}/chat`, {
                message: trimmed,
                conversation_history,
                api_key: apiKey.trim() || null
            })

            if (response.data.error) {
                setMessages((prev) => [
                    ...prev,
                    {
                        role: 'assistant',
                        content: '',
                        error: response.data.error
                    }
                ])
            } else {
                setMessages((prev) => [
                    ...prev,
                    { role: 'assistant', content: response.data.reply || '(No response)' }
                ])
            }
        } catch (error) {
            setMessages((prev) => [
                ...prev,
                {
                    role: 'assistant',
                    content: '',
                    error: error.response?.data?.detail || error.message || 'Request failed'
                }
            ])
        } finally {
            setLoading(false)
        }
    }

    const handleSubmit = (e) => {
        e.preventDefault()
        sendMessage(input)
    }

    const quickPrompts = [
        'How do I test for SQL injection on a login form?',
        'Generate a simple XSS payload for a reflected input',
        'What are the first steps after getting a shell on a Linux box?',
        'Explain SSRF and how to exploit it'
    ]

    return (
        <div className="page">
            <div className="page-header">
                <h1 className="page-title">
                    <span className="page-title-icon">[?]</span>
                    Pentest AI Assistant
                </h1>
                <p className="page-subtitle">
                    Ask questions when stuck or request exploit generation (local Llama model)
                </p>
            </div>

            {/* API Key (collapsible) */}
            <div className="card animate-fade-in" style={{ marginBottom: '1.5rem' }}>
                <div className="card-header">
                    <h2 className="card-title">
                        <span>[key]</span> API Key
                    </h2>
                    <button
                        type="button"
                        className="btn btn-secondary"
                        onClick={() => setShowApiKey(!showApiKey)}
                    >
                        {showApiKey ? 'Hide' : 'Show'}
                    </button>
                </div>
                {showApiKey && (
                    <div className="form-group">
                        <label className="form-label">
                            API key not used (local Llama model). Leave empty.
                        </label>
                        <input
                            type="password"
                            className="form-input"
                            value={apiKey}
                            onChange={(e) => setApiKey(e.target.value)}
                            placeholder="sk-..."
                            autoComplete="off"
                        />
                    </div>
                )}
            </div>

            {/* Chat area */}
            <div className="card animate-fade-in" style={{ marginBottom: '1.5rem', flex: 1, display: 'flex', flexDirection: 'column' }}>
                <div className="card-header">
                    <h2 className="card-title">
                        <span>[chat]</span> Chat
                    </h2>
                </div>

                <div
                    className="results-list"
                    style={{
                        minHeight: '320px',
                        maxHeight: '480px',
                        overflowY: 'auto',
                        marginBottom: '1rem',
                        padding: '0.5rem'
                    }}
                >
                    {messages.length === 0 && (
                        <div className="empty-state">
                            <p className="empty-state-title">No messages yet</p>
                            <p style={{ color: '#6b7280', marginBottom: '1rem' }}>
                                Ask a question or use a quick prompt below.
                            </p>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem', justifyContent: 'center' }}>
                                {quickPrompts.map((prompt, idx) => (
                                    <button
                                        key={idx}
                                        type="button"
                                        className="btn btn-secondary"
                                        style={{ fontSize: '0.8rem' }}
                                        onClick={() => sendMessage(prompt)}
                                    >
                                        {prompt.slice(0, 40)}...
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                    {messages.map((msg, idx) => (
                        <div
                            key={idx}
                            className="result-item"
                            style={{
                                marginBottom: '0.75rem',
                                alignSelf: msg.role === 'user' ? 'flex-end' : 'flex-start',
                                maxWidth: '90%',
                                marginLeft: msg.role === 'user' ? 'auto' : 0,
                                marginRight: msg.role === 'user' ? 0 : 'auto',
                                background: msg.role === 'user' ? 'rgba(0, 212, 255, 0.08)' : 'rgba(0, 0, 0, 0.2)'
                            }}
                        >
                            <div style={{ fontSize: '0.75rem', color: '#6b7280', marginBottom: '0.25rem' }}>
                                {msg.role === 'user' ? 'You' : 'Assistant'}
                            </div>
                            {msg.error ? (
                                <div style={{ color: '#ff4444' }}>{msg.error}</div>
                            ) : (
                                <div
                                    className="chat-message-content"
                                    style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-word' }}
                                >
                                    {msg.content}
                                </div>
                            )}
                        </div>
                    ))}
                    {loading && (
                        <div className="result-item" style={{ background: 'rgba(0, 212, 255, 0.05)' }}>
                            <span className="loading-spinner" style={{ marginRight: '0.5rem' }} />
                            <span style={{ color: '#6b7280' }}>Thinking...</span>
                        </div>
                    )}
                    <div ref={messagesEndRef} />
                </div>

                <form onSubmit={handleSubmit} style={{ display: 'flex', gap: '0.5rem' }}>
                    <input
                        type="text"
                        className="form-input"
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        placeholder="Ask a question or request an exploit..."
                        disabled={loading}
                        style={{ flex: 1 }}
                    />
                    <button type="submit" className="btn btn-primary" disabled={loading || !input.trim()}>
                        Send
                    </button>
                </form>
            </div>
        </div>
    )
}

export default PentestChatPage
