import React, { useState } from 'react'
import axios from 'axios'
import './Pages.css'

const API_BASE = 'http://localhost:8003/api'

function ExploitGeneratorPage() {
    const [exploitType, setExploitType] = useState('sql_injection')
    const [targetEndpoint, setTargetEndpoint] = useState('')
    const [targetParameter, setTargetParameter] = useState('')
    const [generating, setGenerating] = useState(false)
    const [generatedExploit, setGeneratedExploit] = useState(null)

    const exploitTypes = [
        { value: 'sql_injection', label: 'SQL Injection', icon: 'üíâ' },
        { value: 'xss', label: 'XSS (Cross-Site Scripting)', icon: 'üìù' },
        { value: 'command_injection', label: 'Command Injection', icon: 'üíª' },
        { value: 'path_traversal', label: 'Path Traversal', icon: 'üìÅ' },
        { value: 'authentication_bypass', label: 'Authentication Bypass', icon: 'üîì' },
        { value: 'privilege_escalation', label: 'Privilege Escalation', icon: '‚¨ÜÔ∏è' },
        { value: 'ssrf', label: 'SSRF', icon: 'üåê' },
        { value: 'xxe', label: 'XXE', icon: 'üìÑ' },
        { value: 'deserialization', label: 'Deserialization', icon: 'üì¶' },
        { value: 'template_injection', label: 'Template Injection', icon: 'üé®' }
    ]

    const handleGenerateExploit = async () => {
        if (!targetEndpoint.trim()) {
            alert('Please enter a target endpoint')
            return
        }

        setGenerating(true)
        setGeneratedExploit(null)

        try {
            const response = await axios.post(`${API_BASE}/generate-exploit`, {
                exploit_type: exploitType,
                target_endpoint: targetEndpoint.trim(),
                target_parameter: targetParameter.trim() || null
            })
            setGeneratedExploit(response.data)
        } catch (error) {
            console.error('Exploit generation failed:', error)
            alert('Exploit generation failed: ' + (error.response?.data?.detail || error.message))
        } finally {
            setGenerating(false)
        }
    }

    const getImpactColor = (impact) => {
        const colors = {
            critical: '#ff4444',
            high: '#ff8800',
            medium: '#ffaa00',
            low: '#00ff88'
        }
        return colors[impact] || '#6b7280'
    }

    return (
        <div className="page">
            <div className="page-header">
                <h1 className="page-title">
                    <span className="page-title-icon">üí•</span>
                    Exploit Generator
                </h1>
                <p className="page-subtitle">Generate custom exploits for discovered vulnerabilities</p>
            </div>

            {/* Configuration */}
            <div className="card animate-fade-in" style={{ marginBottom: '2rem' }}>
                <div className="card-header">
                    <h2 className="card-title">
                        <span>‚öôÔ∏è</span> Exploit Configuration
                    </h2>
                </div>

                <div className="form-group">
                    <label className="form-label">Exploit Type</label>
                    <select
                        className="form-select"
                        value={exploitType}
                        onChange={(e) => setExploitType(e.target.value)}
                        disabled={generating}
                    >
                        {exploitTypes.map(type => (
                            <option key={type.value} value={type.value}>
                                {type.icon} {type.label}
                            </option>
                        ))}
                    </select>
                </div>

                <div className="grid-2">
                    <div className="form-group">
                        <label className="form-label">Target Endpoint</label>
                        <input
                            type="text"
                            className="form-input"
                            value={targetEndpoint}
                            onChange={(e) => setTargetEndpoint(e.target.value)}
                            placeholder="http://target.com/api/endpoint"
                            disabled={generating}
                        />
                    </div>
                    <div className="form-group">
                        <label className="form-label">Target Parameter (optional)</label>
                        <input
                            type="text"
                            className="form-input"
                            value={targetParameter}
                            onChange={(e) => setTargetParameter(e.target.value)}
                            placeholder="id, username, etc."
                            disabled={generating}
                        />
                    </div>
                </div>

                <button
                    className="btn btn-danger btn-lg"
                    onClick={handleGenerateExploit}
                    disabled={generating || !targetEndpoint.trim()}
                    style={{ marginTop: '0.5rem' }}
                >
                    {generating ? (
                        <>
                            <span className="loading-spinner"></span>
                            Generating Exploit...
                        </>
                    ) : (
                        <>
                            <span>üí•</span>
                            Generate Exploit
                        </>
                    )}
                </button>
            </div>

            {/* Generated Exploit */}
            {generatedExploit && (
                <div className="card animate-fade-in">
                    <div className="card-header">
                        <h2 className="card-title">
                            <span>üéØ</span> Generated Exploit
                        </h2>
                        <span
                            className="badge"
                            style={{
                                background: `${getImpactColor(generatedExploit.impact)}15`,
                                color: getImpactColor(generatedExploit.impact)
                            }}
                        >
                            {generatedExploit.impact.toUpperCase()} IMPACT
                        </span>
                    </div>

                    <div className="grid-2" style={{ marginBottom: '1.5rem' }}>
                        <div className="stat-card">
                            <div className="stat-value" style={{ fontSize: '1.25rem', color: '#00d4ff' }}>
                                {generatedExploit.exploit_type.replace(/_/g, ' ').toUpperCase()}
                            </div>
                            <div className="stat-label">Exploit Type</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value" style={{ color: '#00ff88' }}>
                                {(generatedExploit.success_probability * 100).toFixed(0)}%
                            </div>
                            <div className="stat-label">Success Probability</div>
                        </div>
                    </div>

                    <div className="result-item" style={{ marginBottom: '1rem' }}>
                        <h4 style={{ color: '#fff', marginBottom: '0.75rem' }}>Payload</h4>
                        <div className="code-block">{generatedExploit.payload}</div>
                    </div>

                    <div className="result-item" style={{ marginBottom: '1rem' }}>
                        <h4 style={{ color: '#fff', marginBottom: '0.75rem' }}>Target</h4>
                        <p style={{ color: '#9ca3af', margin: 0 }}>
                            <strong>Endpoint:</strong> {generatedExploit.target_endpoint}
                            {generatedExploit.target_parameter && (
                                <span style={{ marginLeft: '1rem' }}>
                                    <strong>Parameter:</strong> {generatedExploit.target_parameter}
                                </span>
                            )}
                        </p>
                    </div>

                    <div className="result-item" style={{ marginBottom: '1rem' }}>
                        <h4 style={{ color: '#fff', marginBottom: '0.75rem' }}>Description</h4>
                        <p style={{ color: '#9ca3af', margin: 0 }}>{generatedExploit.description}</p>
                    </div>

                    <div className="grid-2">
                        <div className="result-item">
                            <h4 style={{ color: '#ff8800', marginBottom: '0.75rem' }}>‚ö†Ô∏è System Weakness</h4>
                            <p style={{ color: '#9ca3af', margin: 0 }}>{generatedExploit.system_weakness}</p>
                        </div>
                        <div className="result-item">
                            <h4 style={{ color: '#00d4ff', marginBottom: '0.75rem' }}>üîç Vulnerability Analysis</h4>
                            <p style={{ color: '#9ca3af', margin: 0 }}>{generatedExploit.vulnerability_analysis}</p>
                        </div>
                    </div>

                    <div className="grid-2" style={{ marginTop: '1rem' }}>
                        <div className="result-item">
                            <h4 style={{ color: '#9ca3af', marginBottom: '0.75rem' }}>Detection Method</h4>
                            <p style={{ color: '#6b7280', margin: 0 }}>{generatedExploit.detection_method}</p>
                        </div>
                        <div className="result-item" style={{ background: 'rgba(0, 255, 136, 0.05)' }}>
                            <h4 style={{ color: '#00ff88', marginBottom: '0.75rem' }}>‚úÖ Remediation</h4>
                            <p style={{ color: '#9ca3af', margin: 0 }}>{generatedExploit.remediation}</p>
                        </div>
                    </div>
                </div>
            )}
        </div>
    )
}

export default ExploitGeneratorPage
