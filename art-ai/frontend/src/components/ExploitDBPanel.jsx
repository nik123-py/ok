import React, { useState } from 'react'
import axios from 'axios'
import './ExploitDBPanel.css'

const API_BASE = 'http://localhost:8003/api'

function ExploitDBPanel({ currentState, onGenerateExploit }) {
  const [exploitType, setExploitType] = useState('sql_injection')
  const [targetEndpoint, setTargetEndpoint] = useState('')
  const [targetParameter, setTargetParameter] = useState('')
  const [generating, setGenerating] = useState(false)
  const [generatedExploit, setGeneratedExploit] = useState(null)
  const [queryingHints, setQueryingHints] = useState(false)
  const [hintService, setHintService] = useState('')

  const exploitTypes = [
    { value: 'sql_injection', label: 'SQL Injection' },
    { value: 'xss', label: 'XSS (Cross-Site Scripting)' },
    { value: 'command_injection', label: 'Command Injection' },
    { value: 'path_traversal', label: 'Path Traversal' },
    { value: 'authentication_bypass', label: 'Authentication Bypass' },
    { value: 'privilege_escalation', label: 'Privilege Escalation' },
    { value: 'ssrf', label: 'SSRF' },
    { value: 'xxe', label: 'XXE' },
    { value: 'deserialization', label: 'Deserialization' },
    { value: 'template_injection', label: 'Template Injection' }
  ]

  const handleGenerateExploit = async () => {
    if (!targetEndpoint.trim()) {
      alert('Please enter a target endpoint')
      return
    }

    setGenerating(true)
    setGeneratedExploit(null)

    try {
      const response = await axios.post(`${API_BASE}/generate-exploit`, {
        exploit_type: exploitType,
        target_endpoint: targetEndpoint.trim(),
        target_parameter: targetParameter.trim() || null
      })

      setGeneratedExploit(response.data)
    } catch (error) {
      console.error('Exploit generation failed:', error)
      alert('Exploit generation failed: ' + (error.response?.data?.detail || error.message))
    } finally {
      setGenerating(false)
    }
  }

  const handleQueryHints = async () => {
    if (!hintService.trim()) {
      alert('Please enter a service name (e.g., Apache, MySQL, HTTP)')
      return
    }

    setQueryingHints(true)

    try {
      // Query Exploit-DB for hints
      const response = await axios.post(`${API_BASE}/query-hints`, {
        service_name: hintService.trim()
      })

      if (response.data.best_hint) {
        // Refresh state to get updated hints
        const stateResponse = await axios.get(`${API_BASE}/state`)
        // Update currentState by triggering a refresh
        // The parent component will fetch state automatically
        alert(`âœ“ Hint found! ${response.data.best_hint.action.replace(/_/g, ' ').toUpperCase()} suggested for ${hintService}`)
        // Force a page refresh to show the hint
        window.location.reload()
      } else {
        alert(`No hints found for ${hintService}. Try: Apache, MySQL, PostgreSQL, HTTP, etc.`)
      }
    } catch (error) {
      console.error('Hint query failed:', error)
      alert('Hint query failed: ' + (error.response?.data?.detail || error.message))
    } finally {
      setQueryingHints(false)
    }
  }

  return (
    <div className="exploit-db-panel">
      <h3>Exploit-DB Integration</h3>

      {/* Strategic Hint Display - Always Visible */}
      <div className="strategic-hint-section">
        <h4>Strategic Hints from Exploit-DB</h4>
        
        {currentState && currentState.hint_available === 1 ? (
          <div className="strategic-hint-card">
            <div className="hint-header">
              <span className="hint-icon">ðŸ’¡</span>
              <span className="hint-title">Active Strategic Hint</span>
            </div>
            <div className="hint-content">
              <div className="hint-action">
                <strong>Suggested Action:</strong>
                <span className="hint-action-value">{currentState.strategic_hint?.replace(/_/g, ' ').toUpperCase()}</span>
              </div>
              {currentState.hint_service && (
                <div className="hint-service">
                  <strong>Service:</strong> {currentState.hint_service}
                </div>
              )}
              <div className="hint-confidence">
                <strong>Confidence:</strong> {(currentState.hint_confidence * 100).toFixed(0)}%
              </div>
              {currentState.hint_followed && (
                <div className={`hint-result ${currentState.hint_success ? 'success' : 'failed'}`}>
                  {currentState.hint_success ? 'âœ“ Hint followed successfully!' : 'âœ— Hint followed but failed'}
                </div>
              )}
            </div>
          </div>
        ) : (
          <div className="no-hint-card">
            <div className="hint-header">
              <span className="hint-icon">ðŸ’¡</span>
              <span className="hint-title">No Active Hints</span>
            </div>
            <div className="hint-query-form">
              <p>Query Exploit-DB for strategic hints by service name:</p>
              <div className="hint-input-group">
                <input
                  type="text"
                  value={hintService}
                  onChange={(e) => setHintService(e.target.value)}
                  placeholder="e.g., Apache, MySQL, HTTP, PostgreSQL"
                  disabled={queryingHints}
                />
                <button
                  className="btn btn-primary btn-small"
                  onClick={handleQueryHints}
                  disabled={queryingHints || !hintService.trim()}
                >
                  {queryingHints ? 'Querying...' : 'Query Hints'}
                </button>
              </div>
              <p className="hint-note">
                <small>Hints are also automatically generated when you run a simulation with a target host.</small>
              </p>
            </div>
          </div>
        )}
      </div>

      {/* Exploit Generation Section */}
      <div className="exploit-generation-section">
        <h4>Generate Custom Exploit</h4>
        <div className="exploit-form">
          <div className="form-group">
            <label>Exploit Type:</label>
            <select
              value={exploitType}
              onChange={(e) => setExploitType(e.target.value)}
              disabled={generating}
            >
              {exploitTypes.map(type => (
                <option key={type.value} value={type.value}>{type.label}</option>
              ))}
            </select>
          </div>

          <div className="form-group">
            <label>Target Endpoint:</label>
            <input
              type="text"
              value={targetEndpoint}
              onChange={(e) => setTargetEndpoint(e.target.value)}
              placeholder="http://target.com/api/endpoint"
              disabled={generating}
            />
          </div>

          <div className="form-group">
            <label>Target Parameter (optional):</label>
            <input
              type="text"
              value={targetParameter}
              onChange={(e) => setTargetParameter(e.target.value)}
              placeholder="id, username, etc."
              disabled={generating}
            />
          </div>

          <button
            className="btn btn-primary"
            onClick={handleGenerateExploit}
            disabled={generating || !targetEndpoint.trim()}
          >
            {generating ? 'Generating...' : 'Generate Exploit'}
          </button>
        </div>

        {generatedExploit && (
          <div className="generated-exploit">
            <h5>Generated Exploit</h5>
            <div className="exploit-details">
              <div className="exploit-field">
                <strong>Type:</strong> {generatedExploit.exploit_type.replace(/_/g, ' ').toUpperCase()}
              </div>
              <div className="exploit-field">
                <strong>Target:</strong> {generatedExploit.target_endpoint}
                {generatedExploit.target_parameter && (
                  <span> (Parameter: {generatedExploit.target_parameter})</span>
                )}
              </div>
              <div className="exploit-field">
                <strong>Payload:</strong>
                <code className="exploit-payload">{generatedExploit.payload}</code>
              </div>
              <div className="exploit-field">
                <strong>Success Probability:</strong> {(generatedExploit.success_probability * 100).toFixed(0)}%
              </div>
              <div className="exploit-field">
                <strong>Impact:</strong> <span className={`impact-${generatedExploit.impact}`}>{generatedExploit.impact.toUpperCase()}</span>
              </div>
              <div className="exploit-field">
                <strong>Description:</strong>
                <p>{generatedExploit.description}</p>
              </div>
              <div className="exploit-field">
                <strong>System Weakness:</strong>
                <p>{generatedExploit.system_weakness}</p>
              </div>
              <div className="exploit-field">
                <strong>Vulnerability Analysis:</strong>
                <p>{generatedExploit.vulnerability_analysis}</p>
              </div>
              <div className="exploit-field">
                <strong>Detection Method:</strong>
                <p>{generatedExploit.detection_method}</p>
              </div>
              <div className="exploit-field">
                <strong>Remediation:</strong>
                <p>{generatedExploit.remediation}</p>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}

export default ExploitDBPanel

